<!DOCTYPE html>
<html>
<head>
    <title>Graph Explorer - Fixed Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        select, button {
            padding: 10px 15px;
            background: #3a3a3a;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #4a4a4a;
        }
        #cy {
            width: 100%;
            height: 600px;
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
        }
        .status {
            padding: 15px;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        .error {
            border-left-color: #ef4444;
            color: #fca5a5;
        }
        .success {
            border-left-color: #10b981;
            color: #86efac;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .stat-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üï∏Ô∏è Graph Explorer - Working Version</h1>
        
        <div id="status" class="status">Initializing...</div>
        
        <div class="controls">
            <div>
                <label>Domain Filter:</label>
                <select id="domainFilter" onchange="applyFilter()">
                    <option value="">All Domains</option>
                    <option value="artificial_intelligence">AI Research</option>
                    <option value="data_science">Data Science</option>
                    <option value="cloud_computing">Cloud Computing</option>
                </select>
            </div>
            <div>
                <label>Layout:</label>
                <select id="layoutSelect" onchange="changeLayout()">
                    <option value="circle">Circle</option>
                    <option value="grid">Grid</option>
                    <option value="breadthfirst">Hierarchical</option>
                    <option value="concentric">Concentric</option>
                    <option value="cose">Force-directed</option>
                </select>
            </div>
            <button onclick="refreshData()">üîÑ Refresh</button>
            <button onclick="resetView()">üéØ Reset View</button>
            <button onclick="testAPI()">üß™ Test API</button>
        </div>
        
        <div id="cy"></div>
        
        <div class="stats">
            <div class="stat-box">
                <div>Nodes</div>
                <div class="stat-value" id="nodeCount">0</div>
            </div>
            <div class="stat-box">
                <div>Edges</div>
                <div class="stat-value" id="edgeCount">0</div>
            </div>
            <div class="stat-box">
                <div>Status</div>
                <div class="stat-value" id="statusText">Ready</div>
            </div>
        </div>
    </div>

    <script>
        let cy = null;
        let currentData = null;
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStats() {
            if (cy) {
                document.getElementById('nodeCount').textContent = cy.nodes().length;
                document.getElementById('edgeCount').textContent = cy.edges().length;
                document.getElementById('statusText').textContent = 'Connected';
            }
        }
        
        function initCytoscape() {
            try {
                cy = cytoscape({
                    container: document.getElementById('cy'),
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': '#3b82f6',
                                'label': 'data(name)',
                                'text-valign': 'center',
                                'color': '#fff',
                                'text-outline-width': 2,
                                'text-outline-color': '#2a2a2a',
                                'font-size': '12px',
                                'width': 40,
                                'height': 40
                            }
                        },
                        {
                            selector: 'node[type="ResearchDocument"]',
                            style: {
                                'background-color': '#3b82f6',
                                'shape': 'rectangle',
                                'width': 60,
                                'height': 40
                            }
                        },
                        {
                            selector: 'node[type="ResearchConcept"]',
                            style: {
                                'background-color': '#10b981',
                                'shape': 'ellipse'
                            }
                        },
                        {
                            selector: 'node[type="Author"]',
                            style: {
                                'background-color': '#f59e0b',
                                'shape': 'triangle'
                            }
                        },
                        {
                            selector: 'node[type="Methodology"]',
                            style: {
                                'background-color': '#8b5cf6',
                                'shape': 'diamond'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'curve-style': 'bezier',
                                'target-arrow-shape': 'triangle',
                                'line-color': '#666',
                                'target-arrow-color': '#666',
                                'width': 2,
                                'opacity': 0.7
                            }
                        },
                        {
                            selector: ':selected',
                            style: {
                                'background-color': '#ef4444',
                                'line-color': '#ef4444',
                                'target-arrow-color': '#ef4444'
                            }
                        }
                    ],
                    layout: { name: 'circle' },
                    minZoom: 0.1,
                    maxZoom: 5,
                    wheelSensitivity: 0.2
                });
                
                // Event handlers
                cy.on('tap', 'node', function(evt) {
                    const node = evt.target;
                    updateStatus(`Selected: ${node.data('name')} (${node.data('type')})`, 'info');
                });
                
                updateStatus('‚úÖ Graph initialized successfully', 'success');
                return true;
            } catch (error) {
                updateStatus(`‚ùå Failed to initialize: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function loadGraphData() {
            try {
                updateStatus('Loading graph data...', 'info');
                
                const domain = document.getElementById('domainFilter').value;
                const params = new URLSearchParams();
                if (domain) params.append('domain', domain);
                params.append('node_limit', '50');
                params.append('edge_limit', '100');
                
                const response = await fetch(`/api/graph/full?${params}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'API error');
                }
                
                currentData = data;
                
                if (!data.elements || data.elements.length === 0) {
                    updateStatus('No data available for selected filter', 'error');
                    cy.elements().remove();
                    updateStats();
                    return;
                }
                
                // Clear and add elements
                cy.elements().remove();
                cy.add(data.elements);
                
                // Apply layout
                const layoutName = document.getElementById('layoutSelect').value;
                cy.layout({ 
                    name: layoutName,
                    animate: true,
                    animationDuration: 1000
                }).run();
                
                // Fit to view after layout
                setTimeout(() => {
                    cy.fit(null, 50);
                    updateStats();
                    updateStatus(`‚úÖ Loaded ${data.elements.length} elements`, 'success');
                }, 1200);
                
            } catch (error) {
                updateStatus(`‚ùå Failed to load data: ${error.message}`, 'error');
            }
        }
        
        function applyFilter() {
            loadGraphData();
        }
        
        function changeLayout() {
            if (!cy || cy.elements().length === 0) return;
            
            const layoutName = document.getElementById('layoutSelect').value;
            cy.layout({ 
                name: layoutName,
                animate: true,
                animationDuration: 1000
            }).run();
        }
        
        function refreshData() {
            loadGraphData();
        }
        
        function resetView() {
            if (cy) {
                cy.fit(null, 50);
                cy.zoom(1);
                cy.center();
            }
        }
        
        async function testAPI() {
            try {
                updateStatus('Testing API...', 'info');
                const response = await fetch('/api/graph/status');
                const data = await response.json();
                
                if (data.success) {
                    updateStatus(`‚úÖ API OK - ${data.node_count} nodes in database`, 'success');
                } else {
                    updateStatus('‚ùå API connection failed', 'error');
                }
            } catch (error) {
                updateStatus(`‚ùå API test failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            if (typeof cytoscape === 'undefined') {
                updateStatus('‚ùå Cytoscape library not loaded', 'error');
                return;
            }
            
            if (initCytoscape()) {
                loadGraphData();
            }
        });
    </script>
</body>
</html>